<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Edit News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="news.html">News Portal</a>
      <span class="navbar-text ms-2">Editing news</span>
      <button class="btn btn-outline-light ms-auto me-2" onclick="window.location.href='news.html'">
        Back to List
      </button>
      <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
    </div>
  </nav>

  <script>
    function logout() {
      localStorage.removeItem("loggedInUser");
      localStorage.removeItem("userName");
      localStorage.removeItem("authToken");
      window.location.href = "index.html";
    }
  </script>

  <!-- Content -->
  <div class="container mt-5">
    <div id="alertBox"></div>

    <div class="card shadow">
      <div class="card-body">
        <h3 class="card-title mb-3">Edit News</h3>

        <p class="text-muted mb-4">
          <strong>Author:</strong> <span id="authorName">â€”</span>
        </p>

        <!-- Edit form -->
        <form id="editForm" novalidate>
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input id="title" type="text" class="form-control" required />
            <div class="invalid-feedback">Title cannot be empty.</div>
          </div>

          <div class="mb-3">
            <label for="body" class="form-label">Content</label>
            <textarea id="body" class="form-control" rows="6" required></textarea>
            <div class="form-text">Minimum 20 characters.</div>
            <div class="invalid-feedback">Content must be at least 20 characters.</div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
          </div>
        </form>

        <div id="notAllowed" class="alert alert-warning d-none mt-3" role="alert">
          You are not allowed to edit this news because you are not the author.
        </div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const loggedUserId = localStorage.getItem("loggedInUser"); // String ID

    const editForm = document.getElementById("editForm");
    const titleInput = document.getElementById("title");
    const bodyInput = document.getElementById("body");
    const notAllowedBox = document.getElementById("notAllowed");
    const alertBox = document.getElementById("alertBox");
    const authorNameEl = document.getElementById("authorName");

    function showAlert(type, message) {
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }

    function cancelEdit() {
      window.location.href = "news.html";
    }

    async function loadNews() {
      try {
        const res = await fetch(`http://localhost:5000/api/news/${id}`, {
          headers: {
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });
        if (res.status === 401) {
          alert("Unauthorized. Please login.");
          window.location.href = "index.html";
          return;
        }
        const news = await res.json();

        // news.author_id is now an object { _id, name, email }
        authorNameEl.textContent = news.author_id.name || "Unknown";

        // Check ownership
        // loggedUserId is string "696..."
        // news.author_id._id is string "696..."
        if (news.author_id._id !== loggedUserId && news.author_id.id !== loggedUserId) {
          editForm.classList.add("d-none");
          notAllowedBox.classList.remove("d-none");
          return;
        }

        titleInput.value = news.title;
        bodyInput.value = news.body;

        editForm.addEventListener("submit", (e) => handleSubmit(e, news));
      } catch (err) {
        console.error(err);
        showAlert("danger", "Unable to load news.");
      }
    }

    function validateForm() {
      let valid = true;

      if (!titleInput.value.trim()) {
        titleInput.classList.add("is-invalid");
        valid = false;
      } else {
        titleInput.classList.remove("is-invalid");
      }

      if (!bodyInput.value.trim() || bodyInput.value.trim().length < 20) {
        bodyInput.classList.add("is-invalid");
        valid = false;
      } else {
        bodyInput.classList.remove("is-invalid");
      }

      return valid;
    }

    async function handleSubmit(e, news) {
      e.preventDefault();
      if (!validateForm()) return;

      const payload = {
        title: titleInput.value.trim(),
        body: bodyInput.value.trim(),
      };

      try {
        const res = await fetch(`http://localhost:5000/api/news/${news._id}`, { // Use _id
          method: "PUT", // Usually PUT or PATCH. API might follow REST. Previous was PATCH. I'll stick to PATCH or PUT? Prompt didn't specify. Assuming PUT/PATCH works. I'll use PUT as it's common for updates, or stick to PATCH if I want partial. 
          // Previous code used PATCH. I'll stick to PATCH.
          // Wait, the prompt: "use POST api http://localhost:5000/api/auth/login"
          // Didn't specify update method. Common is PUT for full, PATCH for partial.
          // I will use PATCH to be safe with partial updates if backend supports it, or PUT.
          // I'll use PUT as standard for "Edit".
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error("Failed to save changes.");
        showAlert("success", "News updated successfully.");
        setTimeout(() => (window.location.href = "news.html"), 1000);
      } catch (err) {
        showAlert("danger", "Error saving changes.");
      }
    }

    loadNews();
  </script>
</body>

</html>