<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="news.html">News Portal</a>
      <span class="navbar-text ms-2">Editing news</span>
      <button class="btn btn-outline-light ms-auto" onclick="window.location.href='news.html'">
        Back to List
      </button>
    </div>
  </nav>

  <!-- Content -->
  <div class="container mt-5">
    <div id="alertBox"></div>

    <div class="card shadow">
      <div class="card-body">
        <h3 class="card-title mb-3">Edit News</h3>

        <p class="text-muted mb-4">
          <strong>Author:</strong> <span id="authorName">â€”</span>
        </p>

        <!-- Edit form -->
        <form id="editForm" novalidate>
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input id="title" type="text" class="form-control" required />
            <div class="invalid-feedback">Title cannot be empty.</div>
          </div>

          <div class="mb-3">
            <label for="body" class="form-label">Content</label>
            <textarea id="body" class="form-control" rows="6" required></textarea>
            <div class="form-text">Minimum 20 characters.</div>
            <div class="invalid-feedback">Content must be at least 20 characters.</div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
          </div>
        </form>

        <div id="notAllowed" class="alert alert-warning d-none mt-3" role="alert">
          You are not allowed to edit this news because you are not the author.
        </div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const loggedUserId = parseInt(localStorage.getItem("loggedInUser"), 10);

    const editForm = document.getElementById("editForm");
    const titleInput = document.getElementById("title");
    const bodyInput = document.getElementById("body");
    const notAllowedBox = document.getElementById("notAllowed");
    const alertBox = document.getElementById("alertBox");
    const authorNameEl = document.getElementById("authorName");

    function showAlert(type, message) {
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }

    function cancelEdit() {
      window.location.href = "news.html";
    }

    async function loadNews() {
      try {
        const res = await fetch(`http://localhost:3000/news/${id}`);
        const news = await res.json();

        const authorRes = await fetch(`http://localhost:3000/users/${news.author_id}`);
        const author = await authorRes.json();
        authorNameEl.textContent = author.name;

        if (news.author_id !== loggedUserId) {
          editForm.classList.add("d-none");
          notAllowedBox.classList.remove("d-none");
          return;
        }

        titleInput.value = news.title;
        bodyInput.value = news.body;

        editForm.addEventListener("submit", (e) => handleSubmit(e, news));
      } catch (err) {
        showAlert("danger", "Unable to load news.");
      }
    }

    function validateForm() {
      let valid = true;

      if (!titleInput.value.trim()) {
        titleInput.classList.add("is-invalid");
        valid = false;
      } else {
        titleInput.classList.remove("is-invalid");
      }

      if (!bodyInput.value.trim() || bodyInput.value.trim().length < 20) {
        bodyInput.classList.add("is-invalid");
        valid = false;
      } else {
        bodyInput.classList.remove("is-invalid");
      }

      return valid;
    }

    async function handleSubmit(e, news) {
      e.preventDefault();
      if (!validateForm()) return;

      const payload = {
        title: titleInput.value.trim(),
        body: bodyInput.value.trim(),
      };

      try {
        const res = await fetch(`http://localhost:3000/news/${news.id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error("Failed to save changes.");
        showAlert("success", "News updated successfully.");
        setTimeout(() => (window.location.href = "news.html"), 1000);
      } catch (err) {
        showAlert("danger", "Error saving changes.");
      }
    }

    loadNews();
  </script>
</body>
</html>
