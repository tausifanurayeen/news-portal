<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>News Detail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div id="newsDetail" class="card shadow p-4"></div>
    <h4 class="mt-4">Comments</h4>
    <div id="comments" class="list-group mb-3"></div>
    <textarea id="commentText" class="form-control mb-2" placeholder="Add a comment"></textarea>
    <button class="btn btn-primary" onclick="addComment()">Submit Comment</button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const loggedUserId = localStorage.getItem("loggedInUser");

    fetch(`http://localhost:3000/news/${id}`)
      .then(res => res.json())
      .then(news => {
        document.getElementById("newsDetail").innerHTML = `<h2>${news.title}</h2><p>${news.body}</p>`;
        news.comments.forEach(c => {
          fetch(`http://localhost:3000/users/${c.user_id}`)
            .then(res => res.json())
            .then(user => {
              const div = document.createElement("div");
              div.className = "list-group-item";
              div.textContent = `${user.name}: ${c.text}`;
              document.getElementById("comments").appendChild(div);
            });
        });
      });

    function addComment() {
      const text = document.getElementById("commentText").value;
      if (!text) return;
      fetch(`http://localhost:3000/news/${id}`)
        .then(res => res.json())
        .then(news => {
          const newComment = {
            id: Date.now(),
            text,
            user_id: parseInt(loggedUserId),
            timestamp: new Date().toISOString()
          };
          news.comments.push(newComment);
          fetch(`http://localhost:3000/news/${id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comments: news.comments })
          }).then(() => location.reload());
        });
    }
  </script>
</body>
</html>
